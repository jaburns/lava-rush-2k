<canvas id=a width=320 height=200></canvas><h1 id=s></h1><style onload="g=a.getContext('webgl');for(f in g)g[f[0]+f[7]+[f[13]]]=g[f];h=g.cr(),r='attribute vec4 a;void main(){gl_Position=a;}',t=g.ch(35633),g.so(t,r),g.cS(t),g.ah(h,t),r='precision highp float;uniform vec4 g[2];mat2 n(float v){return mat2(cos(v),sin(v),-sin(v),cos(v));}float v(vec2 v){return fract(sin(dot(v,vec2(12.9,4.1)))*43.5);}vec3 f(vec3 v){return abs(v-floor(v)-.5);}float s(vec3 v){float r=dot(f(v*.15+f(v.yzx*.075)),vec3(.444));v=v*1.5773-r;v.yz=vec2(v.y+v.z,v.z-v.y)*.866;v.xz=vec2(v.x+v.z,v.z-v.x)*.866;r+=dot(f(v*.225+f(v.yzx*.1125)),vec3(.222));return abs(r-.5)*1.9+(1.-abs(sin(r*9.)))*.05;}int r;float m(vec3 m){float f=200.;for(float x=-1.;x<=1.;x++){for(float y=-1.;y<=1.;y++){vec2 z=vec2(x,y)+floor((m.xz+10.)/20.);vec3 i=m-vec3(z.x,-5.,z.y)*20.;i.xz*=n(6.3*v(vec2(v(z),4)));vec3 d=abs(i)-vec3(5.+8.*v(vec2(v(z),1)),min(400.,z.y<-1.?0.:r!=1?100.+20.*v(vec2(v(z),2))+5.*z.y:m.y>20.*v(vec2(v(z),2))+5.*z.y?0.:1000.),5.+8.*v(vec2(v(z),3)));f=min(f,length(max(d,0.))+min(max(d.x,max(d.y,d.z)),0.));}}if(r==0)f-=s(m);return.8*f;}vec3 t(vec3 v){vec2 r=vec2(.001,0);return normalize(vec3(m(v+r.xyy)-m(v-r.xyy),m(v+r.yxy)-m(v-r.yxy),m(v+r.yyx)-m(v-r.yyx)));}vec2 x(float v){return v=(v+1.)/2.,vec2(floor(v*255.)/255.,fract(v*255.));}void main(){if(g[0].w>0.){gl_FragColor=vec4(mix(vec3(3,.75,.3),vec3(0),g[0].w/60.),1);return;}float v,f;vec2 z=(gl_FragCoord.xy-.5*vec2(320,200))/200.;vec3 y=g[1].xyz,d=vec3(0,-1,0);r=2;v=0.;for(float i=0.;i<99.;++i){f=m(y);if(f<.001||v>200.)break;v+=f;y+=d*f;}y=g[1].xyz;d=normalize(vec3(z,1));r=1;vec3 i=vec3(0),c=y;float a=m(y-vec3(0,2,0))/.8;if(v<3.)i.y=3.-v;if(a<2.)i.xz=(2.-a)*t(y-vec3(0,2,0)).xz;r=0;if(gl_FragCoord.x<=2.&&gl_FragCoord.y<1.){gl_FragColor=gl_FragCoord.x<1.?vec4(x(i.x),x(i.y)):vec4(x(i.z),v<3.?1:0,0);return;}y+=i;y.y+=.1*(sin(y.x)+sin(y.z));d.yz*=n(g[0].y);d.xz*=n(g[0].x);v=0.;for(float e=0.;e<99.;++e){f=m(y);if(f<.001||v>200.)break;v+=f;y+=d*f;}vec3 e=vec3(0),k;float l,b,w=-(c.y-g[0].z)/d.y;if(w>0.&&(w<v||v>200.))b=2.-s(c+w*d),k=vec3(1),l=0.,v=w;else if(v<200.){b=2.*clamp(1.-.1*(y.y-g[0].z),0.,1.);b*=b;vec3 p=.45+.51*(clamp(abs(mod(fract(.005*(y.x+y.y+y.z))*6.+vec3(0,4,2),6.)-3.)-1.,0.,1.)-.5);float o=s(y);p-=o;p+=pow(1.-o,3.)*vec3(1,.25,.1)*(.75+.25*sin(g[0].z));k=p;vec3 u=g[1].xyz-y;l=.4+.6*dot(normalize(u),t(y));}e=k*b*vec3(3,.75,.3)+k*l;e=mix(vec3(0),e,exp(-v/40.));e=mix(e,vec3(0),-g[0].w/30.);gl_FragColor=vec4(e,1);}',t=g.ch(35632),g.so(t,r),g.cS(t),g.ah(h,t),console.log(g.geL(t)),g.vto(g.lg(h),2,5120,g.eet(g.ur(h)),g.bf(r=34962,g.cu()),g.ba(r,Uint8Array.of(1,1,1,128,128,1),r+82)),A=r=>(b=[0,0,0,-30,0,40,0,0],c=new Uint8Array(8),o=p=q=m=n=i=f=0,k={}),d=.003,a.onclick=r=>(a.requestPointerLock(),a.onmousemove=a.onmousemove||(r=>b[3]==0&&(b[0]+=d*r.movementX,b[1]-=d*r.movementY))),document.onkeydown=r=>(r.keyCode>48&&r.keyCode<58&&(d=.0005*(r.keyCode-48)),k[r.keyCode]=1),document.onkeyup=r=>k[r.keyCode]=0,e=r=>(c[r]/255+c[r+1]/255/255)*2-1,l=r=>(b[3]>180&&A(),p-=.02,b[5]+=p,o=q=0,k[87]&&(o+=Math.sin(b[0]),q+=Math.cos(b[0])),k[83]&&(o-=Math.sin(b[0]),q-=Math.cos(b[0])),k[68]&&(o+=Math.cos(b[0]),q-=Math.sin(b[0])),k[65]&&(o-=Math.cos(b[0]),q+=Math.sin(b[0])),k[32]&&f&&(b[5]+=(p=.5),f=0),o&&q&&(o/=Math.sqrt(q*q+o*o),q/=Math.sqrt(q*q+o*o)),m+=(o-m)/5,n+=(q-n)/5,b[4]+=.4*m,b[6]+=.4*n,b[2]+=.05,(b[5]<b[2]+1||b[3]<0)&&b[3]++||(s.innerText=(i=b[5]>i?b[5]|0:i)),g.re(g.da(4,g.uniform4fv(g.goa(h,'g'),b),3),0,2,1,6408,5121,c),b[4]+=e(0),b[5]+=e(2),b[6]+=e(4),c[6]&&(p=0,f=1),requestAnimationFrame(l)),A(),l()">html,body,canvas{margin:0;font-family:monospace;width:960px;height:600px;image-rendering:pixelated;image-rendering:crisp-edges}h1{color:#fff;position:absolute;left:20px;top:0