<canvas id=a width=960 height=600></canvas><h1 id=s></h1><style onload="g=a.getContext('webgl');for(f in g)g[f[0]+f[7]+[f[13]]]=g[f];h=g.cr(),r='attribute vec4 a;void main(){gl_Position=a;}',t=g.ch(35633),g.so(t,r),g.cS(t),g.ah(h,t),r='precision highp float;uniform vec4 g[2];mat2 n(float v){return mat2(cos(v),sin(v),-sin(v),cos(v));}float f(vec2 v){return fract(sin(dot(v,vec2(12.9,4.1)))*43.5);}vec3 v(vec3 v){return abs(v-floor(v)-.5);}float s(vec3 m){float r=dot(v(m*.15+v(m.yzx*.075)),vec3(.444));m=m*1.5773-r;m.yz=vec2(m.y+m.z,m.z-m.y)*.866;m.xz=vec2(m.x+m.z,m.z-m.x)*.866;r+=dot(v(m*.225+v(m.yzx*.1125)),vec3(.222));return abs(r-.5)*1.9+(1.-abs(sin(r*9.)))*.05;}int r;float m(vec3 v){float m=200.;for(float x=-1.;x<=1.;x++){for(float y=-1.;y<=1.;y++){vec2 d=vec2(x,y)+floor((v.xz+10.)/20.);vec3 z=v-vec3(d.x,-5.,d.y)*20.;z.xz*=n(6.3*f(d+344.));vec3 c=abs(z)-vec3(5.+8.*f(d+86.),min(400.,d.y<-1.?0.:r!=1?100.+20.*f(d+172.)+5.*d.y:v.y>20.*f(d+172.)+5.*d.y?0.:1000.),5.+8.*f(d+258.));if(r==0)c+=1.;m=min(m,length(max(c,0.))+min(max(c.x,max(c.y,c.z)),0.));}}if(r==0)m-=1.,m-=s(v);return.8*m;}vec3 t(vec3 v){vec2 r=vec2(.001,0);return normalize(vec3(m(v+r.xyy)-m(v-r.xyy),m(v+r.yxy)-m(v-r.yxy),m(v+r.yyx)-m(v-r.yyx)));}vec2 x(float v){return v=(v+1.)/2.,vec2(floor(v*255.)/255.,fract(v*255.));}void main(){if(g[0].w>0.){gl_FragColor=vec4(mix(vec3(3,.75,.3),vec3(0),g[0].w/60.),1);return;}float v,f;vec2 z=(gl_FragCoord.xy-.5*vec2(960,600))/600.;vec3 d=g[1].xyz,y=vec3(0,-1,0);r=2;v=0.;for(float o=0.;o<99.;++o){f=m(d);if(f<.001||v>200.)break;v+=f;d+=y*f;}d=g[1].xyz;y=normalize(vec3(z,1));r=1;vec3 c=vec3(0),e=d;float a=m(d-vec3(0,2,0))/.8;if(v<3.)c.y=3.-v;if(a<2.)c.xz=(2.-a)*t(d-vec3(0,2,0)).xz;r=0;if(gl_FragCoord.x<=2.&&gl_FragCoord.y<1.){gl_FragColor=gl_FragCoord.x<1.?vec4(x(c.x),x(c.y)):vec4(x(c.z),v<3.?1:0,0);return;}d+=c;d.y+=.1*(sin(d.x)+sin(d.z));y.yz*=n(g[0].y);y.xz*=n(g[0].x);v=0.;for(float o=0.;o<99.;++o){f=m(d);if(f<.001||v>200.)break;v+=f;d+=y*f;}vec3 o=vec3(0);float p=-(e.y-g[0].z)/y.y;if(p>0.&&(p<v||v>200.))o=(2.-s(e+p*y))*vec3(3,.75,.3),v=p;else if(v<200.){vec3 l=.45+.51*(clamp(abs(mod(fract(.005*(d.x+d.y+d.z))*6.+vec3(0,4,2),6.)-3.)-1.,0.,1.)-.5);f=s(d);l-=f;l+=pow(1.-f,3.)*vec3(1,.25,.1)*(.75+.25*sin(g[0].z));o=l*(pow(2.*clamp(1.-.1*(d.y-g[0].z),0.,1.),2.)*vec3(3,.75,.3)+.4+.6*dot(normalize(g[1].xyz-d),t(d)));}o=mix(vec3(0),o,exp(-v/40.));o=mix(o,vec3(0),-g[0].w/30.+min(1.,g[1].w/180.));gl_FragColor=vec4(o,1);}',t=g.ch(35632),g.so(t,r),g.cS(t),g.ah(h,t),g.vto(g.lg(h),2,5120,g.eet(g.ur(h)),g.bf(r=34962,g.cu()),g.ba(r,Uint8Array.of(1,1,1,128,128,1),r+82)),A=r=>(b=[0,0,0,-30,0,40,0,0],c=new Uint8Array(8),o=p=q=m=n=i=f=0,k={}),d=.003,a.onclick=r=>(a.requestPointerLock(),a.onmousemove=a.onmousemove||(r=>!b[3]&&b[7]<1&&(b[0]+=d*r.movementX,b[1]-=d*r.movementY))),document.onkeydown=r=>(r.keyCode>48&&r.keyCode<58&&(d=.0005*(r.keyCode-48)),k[r.keyCode]=1),document.onkeyup=r=>k[r.keyCode]=0,e=r=>(c[r]/255+c[r+1]/255/255)*2-1,l=r=>(b[3]>180&&A(),p-=.02,b[5]+=p,o=q=0,b[7]<1&&(k[87]&&(o+=Math.sin(b[0]),q+=Math.cos(b[0])),k[83]&&(o-=Math.sin(b[0]),q-=Math.cos(b[0])),k[68]&&(o+=Math.cos(b[0]),q-=Math.sin(b[0])),k[65]&&(o-=Math.cos(b[0]),q+=Math.sin(b[0])),k[32]&&f&&(b[5]+=(p=.5),f=0),o&&q&&(o/=Math.sqrt(q*q+o*o),q/=Math.sqrt(q*q+o*o)),b[2]+=.05),m+=(o-m)/5,n+=(q-n)/5,b[4]+=.4*m,b[6]+=.4*n,(b[5]<b[2]+1||b[3]<0)&&b[3]++||(s.innerText=(i=b[5]>i?b[5]|0:i)),g.re(g.da(4,g.uniform4fv(g.goa(h,'g'),b),3),0,2,1,6408,5121,c),b[4]+=e(0),b[5]+=e(2),b[6]+=e(4),c[6]&&(p=0,f=1,!b[7]&&i>308&&(++b[7],i=b[2]/.05,i=(i/60|0)+'.'+(i=i/.6%100|0,i>9?i:'0'+i)+' s')),b[7]&&b[7]++,requestAnimationFrame(l)),A(),l()">html,body,canvas{margin:0;font-family:monospace;width:960px;height:600px;image-rendering:pixelated;image-rendering:crisp-edges}h1{color:#fff;position:absolute;left:20px;top:0